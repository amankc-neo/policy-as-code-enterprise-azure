name: Policy Check

on:
  push:
    paths:
      - '**.rego'
      - '**.yaml'
      - '**.yml'
  pull_request:

jobs:
  policy-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install OPA and Conftest
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
        chmod +x opa && sudo mv opa /usr/local/bin/
        wget https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
        tar -xzf conftest_Linux_x86_64.tar.gz
        sudo mv conftest /usr/local/bin/

    - name: Run policy checks
      run: |
        conftest test test-data/sample-deployment.yaml --policy policies/
